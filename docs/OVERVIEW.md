# FlowGuard AI - プロジェクト概要

## 概要

FlowGuard AI は、イベントリスクをシミュレーションし、関係者で共有・対策までを一気通貫で扱う Web アプリケーションです。地図（Google Maps / Cesium）、バックエンドの AI 分析（FastAPI + Vertex AI Gemini）、リアルタイム共有（Firebase Firestore）を組み合わせ、主催者・警備・自治体・会場管理者が、イベント前からリスクを予測・分析・軽減策の検討を行えるようにします。

## 対象ユーザー

- **イベント主催者** … リスクを考慮したイベント設定・エリア選定と、対策 ToDo の管理。
- **警備・安全担当** … AI が検出したリスクの重要度・深刻度・対策タスクの確認と、現場対応の優先付け。
- **自治体・会場管理者** … 運営・交通・法規制などのリスク評価と、関係者との情報共有。
- **同一プロジェクトで協働するチーム** … 参加コードで 1 つのプロジェクトに参加し、ToDo の進捗・ピン・採用提案などをリアルタイムで同期。

## 解決する課題

1. **リスクの分断** … 群衆・交通・気象・運営などが別々に評価されがちな問題に対し、複数カテゴリのリスクを 1 つの地図とダッシュボードで統合して表示する。
2. **事後対応中心の計画** … 「もし〇〇だったら」の比較がしづらいため、What-if 比較で複数ケースを並べ、**現在の結果とも比較**したうえで現在より改善している案のみおすすめし、採用まで行えるようにする。
3. **協働時の状態のバラつき** … 複数人が同じイベントを扱う際、ToDo の完了状況・ピン・判断履歴をリアルタイムで揃えるため、Firestore で 1 つの参加コード単位に同期する。
4. **引き継ぎ・記録の不足** … リスク・対策・現場確認メモを盛り込んだ PDF レポート（フル版・1 枚サマリー）を出力し、ブリーフィングや引き継ぎに利用できるようにする。

## ソリューションの特徴

- **3 ステップの流れ**  
  ステップ 1（イベント設定）→ ステップ 2（エリア指定）→ ステップ 3（リスク分析ダッシュボード）。ステッパーと戻る操作で流れを明確にしている。

- **多層リスクモデル**  
  6 カテゴリ（群衆安全、交通・物流、環境・保健、運営、視界・見通し、法規制対応）。深刻度・発生確率・重要度・緊急度・実行難易度を持ち、ダッシュボードではフィルタと並び替えで一覧を操作する。

- **2D / 3D 地図**  
  2D は Google Maps（道路地図・ラベルなし・ハイブリッド・衛星）。写真・ハイブリッド時も拡大で 2.5D にならないよう tilt を 0 に固定（エリア指定画面・解析画面とも同じ挙動）。3D は Cesium で同一エリアとリスク文脈を表示。地図のパフォーマンス（ズーム・オーバーレイ更新）を最適化している。

- **プロジェクト共有**  
  プロジェクト作成で 6 文字の参加コードを発行。他者がそのコードで参加すると、イベント設定・ポリゴン・シミュレーション結果・ToDo チェック・提案の採用/却下ログ・採用済み提案・ピン・地図 ToDo が Firestore で保存・同期される。参加コードごとに 1 つのリアルタイムリスナーで、離脱・アンマウント時に解除しメモリリークを防ぐ。

- **日英対応**  
  デフォルトは日本語。ヘッダーで英語(EN)に切り替えると、UI は英語になり、シミュレーション結果はバックエンドの翻訳 API で英語表示される。翻訳はチャンク並列実行で高速化している。

- **PDF エクスポート**  
  フルレポートまたは 1 枚サマリーをダウンロード。シミュレーション要約・リスク・対策効果（スコア・リスク項目数の前後）・現場確認メモ・採用 ToDo・ピンを含む。

- **解析 AI（Gemini 3 Pro）**  
  リスクシミュレーションは Vertex AI の Gemini 3 Pro（`gemini-3-pro-preview`）を使用。グローバルエンドポイント・思考レベル高（`thinking_level=HIGH`）で推論を最大化し、複雑なリスク分析に対応する。

- **アプリガイド AI**  
  画面上の AI アシスト（フロートボタン）から、アプリの使い方・画面・ボタンの意味・アラート閾値の説明などを質問できる。Gemini 2.5 Flash がアプリガイドに基づいて回答する。

- **分析タブの対策反映**  
  分析サマリーと時間帯ごとのリスクは、ToDo の完了状況に応じてリアルタイムで再計算され表示される。対策効果パネルではスコア・リスク項目数・混雑ピークの前後差を表示する（危険ポイント数は表示しない）。

- **地図 ToDo**  
  参加中は地図上に「ここを直す」のような ToDo を追加でき、対策 ToDo リストと統合される。マーカーをクリックすると InfoWindow から削除可能。

## スコープ外（現バージョン）

- プロジェクト共有以外のユーザー認証は行わない（Firebase 匿名認証のみ）。
- シミュレーションの履歴・バージョン管理は行わない。プロジェクトごとに「直近 1 回」の結果のみ保持。
- Firestore の複合インデックスは使用しない。すべて参加コード（ドキュメント ID）による単一ドキュメントアクセス。
