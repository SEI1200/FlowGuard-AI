# FlowGuard AI - 機能一覧と利用手順

## 機能一覧

### ランディングとプロジェクトモード

- **新規で作成**  
  Firestore にプロジェクトドキュメントを作成し、匿名サインインする。参加コードをセッションストレージに保存し、本流（3 ステップ）へ遷移する。Firebase の設定（VITE_FIREBASE_*）が必要。

- **参加コードで参加**  
  6 文字のコードを入力すると、プロジェクトデータを読み込み、そのドキュメントをリアルタイム購読する。無効・未存在のコードの場合はエラー表示。

- **プロジェクトを抜ける**  
  参加コードとローカルのプロジェクト状態をクリアし、Firestore の購読を解除する。ステッパーはステップ 0 に戻る。

### ステップ 1 – イベント設定（MissionSetup）

- **入力項目**  
  イベント名、イベント種別（音楽フェス・花火・展示会・学園祭等）、開催場所（自由文）、開催日（YYYY-MM-DD）、開始・終了時刻（HH:mm）、予想来場者数、来場者属性（若年層・ファミリー・高齢者・混合等）、補足事項。任意で役割（主催者・警備・自治体・施設管理）、アラート閾値（保守的・標準・攻め）。

- **アラート閾値**  
  リスク検出の感度。保守的＝やや厳しめに多く検出、標準＝バランス、攻め＝重要度の高いものに絞る。ラベル横の「?」ボタンを押すと Popover で説明文を表示。分析結果の件数・推奨の出方に影響する。

- **テンプレート**  
  バックエンドから取得したシナリオテンプレートを選択し「テンプレートを適用」でフォームに反映できる。次へ進む前にバリデーションを実行。

- **バリデーション**  
  クライアントおよび API（/api/validate）で入力チェック。エラーがあればフォーム上に表示。成功時、プロジェクト参加中なら設定を Firestore に保存し、ステップ 2 へ進む。

### ステップ 2 – エリア指定

- **地図**  
  Google Maps（vis.gl）で、ステップ 1 の開催場所からジオコードした中心を表示。クリックで頂点を追加してポリゴンを描く。地図タイプ（道路・写真など）は画面上で切替可能。**写真地図でも拡大時に 2.5D にならず常に 2D**（解析画面の写真地図と同じ tilt 固定）。（道路スナップはバックエンド API で提供済みだが、現バージョンの UI からは未呼び出し。）

- **操作**  
  頂点追加、最後の 1 点取り消し、クリア、エリア確定。頂点は 3 点以上必要。確定でシミュレーションを実行し、ステップ 3（ダッシュボード）へ遷移する。

- **永続化**  
  プロジェクト参加中は、確定時のポリゴンを Firestore に保存する。

### ステップ 3 – リスク分析ダッシュボード

- **レイアウト**  
  上部: イベント名、リスク件数チップ、2D/3D 切替、ピン追加・地図 ToDo 追加（参加時）、PDF バリアント選択、PDF エクスポート。短い「次のステップ」ヒント。左・中央・右の 3 列: 左＝リスクレイヤー・並び替え・リスク一覧、中央＝地図または 3D、右＝タブ（分析 / 対策・次アクション / ToDo・比較・メモ）。

- **2D 地図**  
  MapView: ポリゴンオーバーレイ、交通レイヤー（任意）、衛星/ハイブリッド時は傾き 0 に固定。地図タイプ: 道路地図、道路地図（ラベルなし）、ハイブリッド、衛星。参加時はピンと地図 ToDo のマーカーを表示。ピン追加モードでは地図クリックでピン追加し、ダイアログで名前・メモ・種別を入力。地図 ToDo 追加モードでは「ここを直す」のようにクリックで ToDo を追加。地図 ToDo のマーカーをクリックすると InfoWindow が開き、削除ボタンで Firestore から削除できる。

- **3D 地図**  
  Cesium でイベントエリアとリスク文脈を表示。3D ではピン・地図 ToDo の編集は行わない。

- **リスク一覧**  
  RiskLayerControl のカテゴリトグルで表示するカテゴリを切り替え。「解決したリスクを非表示」スイッチで、採用 ToDo がすべてチェック済みのリスクを一覧から隠せる。並び替えは深刻度・重要度・緊急度・実行難易度。リスクをクリックすると右パネルに詳細を表示。

- **右パネル – 分析タブ**  
  未選択時: 分析サマリー（要約文）。ToDo が 1 件以上完了しているときは、対策反映後の説明文を表示し、その下に「対策前の分析」として元の要約を表示。複合条件リスク、時間帯ごとのリスク（ToDo 完了に応じてリアルタイムで下方修正されたスコア）、ボトルネック、主な推奨事項。リスク選択時: **説明文・深刻度以降の要因分解・軽減策・連鎖リスクなどは折り返しで全文表示**（途中で切れない）。確率・深刻度・対策アクション・要因分解・「次にやるべき」提案（採用/却下/保留・ToDo として採用）。対策効果（対策前→対策後）は総合スコア・リスク項目数・混雑ピークの差分を表示（危険ポイント数は表示しない）。

- **右パネル – 対策・次アクションタブ**  
  対策案と ToDo、次にやるべき提案と採用/却下/保留・ToDo 採用の操作。

- **右パネル – ToDo・比較・メモタブ**  
  対策 ToDo リスト（チェックで完了。参加時は Firestore で同期）。担当・現場確認済みの入力。What-if 比較（別シナリオを実行してケース追加。現在の結果も含めて比較し、現在よりスコア・危険ポイントが改善している追加ケースがある場合のみ「おすすめ」を表示。おすすめを採用で現在結果に反映）。現場確認メモ（PDF に含まれる項目）。

- **ピン**  
  参加時、地図クリックでピン追加。名前・メモ・種別（警備配置・危険・注意・誘導・その他）を設定。一覧は Firestore で同期。詳細ダイアログで編集・削除可能。

- **地図 ToDo**  
  参加時、地図 ToDo 追加モードで地図をクリックすると「ここを直す」用の ToDo が追加され、対策 ToDo リストに統合される。地図上のマーカーをクリックすると InfoWindow が開き、削除で Firestore から削除する。

- **PDF エクスポート**  
  フル版または 1 枚要約。シミュレーション要約・リスク・対策効果（スコア・リスク項目数の前後）・現場確認メモ・採用 ToDo・ピンを含む。ファイル名はシミュレーション ID の先頭 8 文字を含む（例: `FlowGuard_Report_xxxxxxxx_1page.pdf`）。

### 設定・システム・言語

- **設定ダイアログ**  
  アプリバー右上の設定アイコンから開く。シミュレーションタイムアウトの説明、API ベース URL（未設定時は「未設定・相対パス」等の表示）、「アーキテクチャ・費用・運用設計」ボタンでシステム情報ダイアログを開く。

- **言語**  
  アプリバー右上で日本語(JP)・英語(EN)を切替。EN 時はシミュレーション結果をバックエンドの翻訳 API で英語表示する（チャンク並列で高速化）。UI 文言はすべて翻訳キーで日英切り替え。

- **システム情報**  
  設定から開く。アーキテクチャ・費用対効果・運用設計のタブで、使用サービス・データフロー・推論ポイント・スケール方針・コスト目安・当日運用フロー・緊急時手順などを表示。

- **AI アシスト（アプリガイド・コンテキスト応答）**  
  画面右下のフロートボタンで開く。LINE 風のチャット UI。パネルはドラッグで移動、右下のハンドルでリサイズ可能。初回表示時に挨拶メッセージ。ユーザーが質問を送ると /api/assist に送信する。オプションで現在の画面状態（ステップ・分析結果の要約・リスク数・ToDo 進捗・ピン数・地図 ToDo 数・レポート本文）を context として送ると、それらを前提に「次にどのタブを開くか」「どの ToDo を優先するか」など次のアクションを提案する。ダッシュボード表示時は PDF フル版と同じレポート本文を渡し、具体的な質問にはその内容を基に簡潔（2〜5 文程度）で回答する。ガイドに基づいた操作 Q&A に加え、コンテキストに応じた支援が可能。

## UI 仕様（要点）

- **アプリバー**  
  ロゴ/タイトル、参加コードチップ＋コピー（参加時）、言語切替（JP/EN）、設定アイコン（一番右上）、プロジェクトを抜ける（参加時）。絵文字は使わない。

- **ステッパー**  
  ステップ 2 未満、またはローディング・エラー・完了フェーズのときに表示。ラベル: イベント設定、エリア指定、リスク分析。ローディング・完了中はステップ 2 をアクティブ表示。

- **メインコンテンツ**  
  ステップに応じて MissionSetup / AreaDesignation または RiskDashboard。ダッシュボードは flex レイアウトで、左・右列は独立してスクロール、中央の地図は固定でスクロールしない。

- **地図コントロールオーバーレイ**  
  2D 時のみ。左上: 地図タイプ。左下: 交通レイヤー ON 時に交通凡例（イベント日の曜日を表示）。

## 利用手順（ユーザー向け）

1. **開始**  
   アプリを開く。「新規で作成」（参加コードを取得して共有）または「参加コードで参加」（コード入力）を選ぶ。

2. **イベント設定**  
   イベント名・種別・場所・日時・来場者数・来場者属性・補足を入力。テンプレートがあれば適用。アラート閾値は「?」で説明を確認して選択。次へでエリア指定へ。

3. **エリア指定**  
   地図上でクリックしてポリゴン頂点を追加。クリア・取り消しで調整し、「ポリゴン確定」でシミュレーション実行しダッシュボードを開く。

4. **ダッシュボード**  
   左パネルでリスクカテゴリの表示 ON/OFF と並び替えを変更。必要なら「解決したリスクを非表示」を ON。リスクをクリックすると右に詳細。右パネルは分析・対策・ToDo・比較・メモのタブで切り替え。2D/3D と地図タイプ（2D）を切り替え可能。共有プロジェクトでは地図でピン・地図 ToDo を追加し、ToDo にチェックを入れると対策効果・分析サマリー・時間帯リスクがリアルタイムで更新される。What-if で別シナリオを実行し、おすすめを採用して現在結果に反映できる。PDF はフルまたは 1 枚をエクスポート。

5. **離脱**  
   「プロジェクトを抜ける」で同期をやめ、ランディングに戻る。同じコードで再参加すれば同じプロジェクトを続けられる。

## 動作上のポイント

- 外部から見た挙動は、同一画面・同一操作・同一データフローを維持している。パフォーマンス（地図ズーム・Firestore の読み削減・アンマウント時の購読解除）とコード構造（ピン種別の DRY、地図とコールバックのメモ化）の改善を行っている。
- 分析タブの「分析サマリー」「時間帯ごとのリスク」は、ToDo の完了状況に応じてリアルタイムで再計算され、対策反映後の見え方になる。危険ポイントの表示は行わない。
- 日英切替時、未翻訳の文言が出ないよう UI はすべて翻訳キーで切り替え、シミュレーション本文は EN 時に翻訳 API で英語表示する。
